<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Page</title>
    <link href="/static/quiz_page.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-4">
            <h2 class="text-2xl font-bold" id="quiz-title">Quiz</h2>
            <div id="timer" class="text-lg">Time Remaining: <span id="time-display"></span></div>
        </div>

        <div id="quiz-content" class="space-y-6">
            <!-- Questions will be loaded here dynamically -->
        </div>

        <div class="mt-8">
            <button id="submit-quiz" class="bg-blue-500 text-white px-6 py-2 rounded">
                Submit Quiz
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with sample data (replace with actual data in production)
            let timeRemaining = 3600; // 1 hour in seconds
            const quizId = 1; // Sample quiz ID
            let questions = [];
            let currentAnswers = {};

            // Load quiz questions
            fetch(`/api/quiz/${quizId}/questions`)
                .then(response => response.json())
                .then(data => {
                    questions = data.questions;
                    renderQuestions();
                    startTimer();
                    loadQuizState();
                });

            function renderQuestions() {
                const container = document.getElementById('quiz-content');
                questions.forEach(question => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-container p-4 border rounded';
                    questionDiv.innerHTML = `
                        <p class="font-semibold mb-2">${question.text}</p>
                        <div class="options-container space-y-2">
                            ${question.options.map((option, index) => `
                                <div class="option">
                                    <input type="radio" 
                                           name="question_${question.id}" 
                                           value="${index}"
                                           id="q${question.id}_opt${index}"
                                           onchange="handleAnswerSubmission(${question.id}, ${index})">
                                    <label for="q${question.id}_opt${index}">${option.text}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(questionDiv);
                });
            }

            function loadQuizState() {
                fetch(`/api/quiz/${quizId}/state`)
                    .then(response => response.json())
                    .then(data => {
                        currentAnswers = data.answered_questions;
                        // Restore previous answers
                        Object.entries(currentAnswers).forEach(([questionId, answer]) => {
                            const radio = document.querySelector(
                                `input[name="question_${questionId}"][value="${answer.selected_option}"]`
                            );
                            if (radio) radio.checked = true;
                        });
                    });
            }

            // Made the function global so it can be accessed from inline HTML
            window.handleAnswerSubmission = function(questionId, optionIndex) {
                fetch(`/api/quiz/${quizId}/question/${questionId}/answer`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({selected_option: optionIndex})
                });
            }

            function startTimer() {
                const timerDisplay = document.getElementById('time-display');
                const timer = setInterval(() => {
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = timeRemaining % 60;
                    timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeRemaining <= 0) {
                        clearInterval(timer);
                        submitQuiz();
                    }
                    timeRemaining--;
                }, 1000);
            }

            function submitQuiz() {
                fetch(`/api/quiz/${quizId}/submit`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                });
            }

            // Add event listener for submit button
            document.getElementById('submit-quiz').addEventListener('click', submitQuiz);
        });
    </script>
</body>
</html>